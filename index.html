<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mermaid Diagram Generator</title>
  <!-- Mermaidライブラリの読み込み（バージョン指定） -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea { width: 100%; height: 150px; margin-bottom: 10px; font-family: monospace; }
    #diagram { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    button { margin-right: 10px; padding: 8px 16px; }
  </style>
</head>
<body>
  <h1>Mermaid Diagram Generator</h1>
  <!-- Mermaidコード入力欄 -->
  <textarea id="mermaidInput" placeholder="ここにMermaid形式のコードを入力してください">
graph TD
  A[Start] --> B{Is it?}
  B -- Yes --> C[OK]
  B -- No --> D[Not OK]
  D --> E[End]
  </textarea>
  <br>
  <!-- グラフ更新・画像ダウンロードボタン -->
  <button id="updateBtn">グラフ更新</button>
  <button id="downloadSVGBtn">SVGダウンロード</button>
  <button id="downloadPNGBtn">PNGダウンロード</button>
  
  <!-- グラフ表示用コンテナ -->
  <div id="diagram"></div>
  
  <script>
    // Mermaidの初期化（securityLevel: 'loose' を設定）
    mermaid.initialize({
      startOnLoad: false,
      securityLevel: 'loose'
    });
    
    // Mermaidコードを読み込み、.mermaid 要素としてコンテナに挿入し、mermaid.init でレンダリングする関数
    function renderDiagram() {
      const input = document.getElementById('mermaidInput').value;
      const container = document.getElementById('diagram');
      // 以前のグラフをクリアし、.mermaidクラスのdivにコードをセット
      container.innerHTML = '<div class="mermaid">' + input + '</div>';
      // mermaid.init を使ってレンダリング
      mermaid.init(undefined, container);
    }
    
    // イベントリスナーの登録
    document.getElementById('updateBtn').addEventListener('click', renderDiagram);
    
    // SVGダウンロード機能
    function downloadSVG() {
      const container = document.getElementById('diagram');
      const svgElement = container.querySelector('svg');
      if (!svgElement) {
        alert("グラフが生成されていません。");
        return;
      }
      const serializer = new XMLSerializer();
      let source = serializer.serializeToString(svgElement);
      // 必要な名前空間の追加
      if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
        source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
      }
      if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
        source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
      }
      source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
      const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
      const downloadLink = document.createElement("a");
      downloadLink.href = url;
      downloadLink.download = "diagram.svg";
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }
    
    // PNGダウンロード機能
    function downloadPNG() {
      const container = document.getElementById('diagram');
      const svgElement = container.querySelector('svg');
      if (!svgElement) {
        alert("グラフが生成されていません。");
        return;
      }
      const serializer = new XMLSerializer();
      let svgString = serializer.serializeToString(svgElement);
      if (!svgString.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
        svgString = svgString.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
      }
      if (!svgString.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
        svgString = svgString.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
      }
      svgString = '<?xml version="1.0" standalone="no"?>\r\n' + svgString;
      
      const svgBlob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(svgBlob);
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const context = canvas.getContext('2d');
        context.drawImage(img, 0, 0);
        URL.revokeObjectURL(url);
        canvas.toBlob(function(blob) {
          const downloadLink = document.createElement("a");
          downloadLink.href = URL.createObjectURL(blob);
          downloadLink.download = "diagram.png";
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
        });
      };
      img.onerror = function() {
        alert("PNG画像の生成に失敗しました。");
      };
      img.src = url;
    }
    
    // ダウンロードボタンのイベント登録
    document.getElementById('downloadSVGBtn').addEventListener('click', downloadSVG);
    document.getElementById('downloadPNGBtn').addEventListener('click', downloadPNG);
    
    // 初期レンダリング
    renderDiagram();
  </script>
</body>
</html>
